<html>
  <head>
    <title>Sharing Code With Views - Kanso Framework</title>
    <link rel="stylesheet" href="http://yandex.st/highlightjs/5.16/styles/github.min.css">
    <link rel="stylesheet" href="../css/kanso.css" />
    <!--[if IE]>
      <link rel="stylesheet" href="../css/kanso_ie.css" />
    <![endif]-->
  </head>
  <body>
    <div id="topbar">
      <a id="logo" href="../index.html">
        <img src="../images/kanso_small.png" />
      </a>
      <a id="site" href="../index.html">Framework</a>
      <div id="rightmenu">
        <ul id="topmenu">
          <li>
            <a href="../index.html">About</a>
          </li>
          <li class="active">
            <a href="../guides/index.html">Guides</a>
          </li>
          <li>
            <a href="../community.html">Community</a>
          </li>
          <li>
            <a href="../api/index.html">API</a>
          </li>
          <li>
            <a href="https://github.com/caolan/kanso">Code</a>
          </li>
          <li>
            <a href="../download.html">Download</a>
          </li>
        </ul>
        <!--
        <ul id="sessionmenu">
          <li><a href="#">Create Account</a></li>
          <li><a href="#">Sign In</a></li>
        </ul>
        -->
      </div>
    </div>

    <div id="content">
      <h1>Sharing Code With Views</h1>

<p>As of CouchDB 1.1.0, its possible to share code between views
(map/reduce functions) and other parts of your couchapp by putting the modules
in the <code>views/lib</code> directory. To add a new directory of modules in
Kanso, you need to edit the kanso.json configuration file, so it looks something
like the following:</p>

<pre><code class="javascript">{
    "name": "myapp",
    "load": "lib/app",
    "modules": ["lib", "views"],
    "templates": "templates",
    "attachments": "static"
}</code></pre>

<p>Note that you can use either a single string or an array of strings to represent
modules directories (same goes for attachments). Once you've added the views
directory to kanso.json, create the <code>views</code> and <code>views/lib</code>
and add your shared module code in there:</p>

<h2>views/lib/example.js</h2>

<pre><code class="javascript">exports.fn = function () {
    return 42;
};</code></pre>

<h2>Using shared modules</h2>

<p>When using a module inside a view, you need to remember that views are not
context-aware like list, show or update functions. They do not have access to
their surrounding scope. Each map or reduce function needs to be completely
self-contained so CouchDB can detect when it has changed and update the index.
Because of this, you need to make sure you require the shared module inside the
function:</p>

<pre><code class="javascript">exports.example_view = {
    map: function (doc) {
        // this must be placed *inside* the map function
        var example = require('views/lib/example');
        if (doc.num) {
            emit(doc._id, example.fn());
        }
    }
};</code></pre>

<p>After pushing these changes and making sure you have some example documents,
requesting this view should give results similar to the following:</p>

<pre><code class="javascript">{
    "total_rows": 2,
    "offset": 0,
    "rows": [
        {
            "id": "cfe0bf4ac09fd7cf1efad645d2abf376",
            "key": "cfe0bf4ac09fd7cf1efad645d2abf376",
            "value": 42
        },
        {
            "id": "cfe0bf4ac09fd7cf1efad645d2abfd85",
            "key": "cfe0bf4ac09fd7cf1efad645d2abfd85",
            "value": 42
        }
    ]
}</code></pre>

<p>The value of each row is the result of calling <code>example.fn()</code>. In
other modules in your application, you can require the new example module by
doing <code>require('views/lib/example')</code>.</p>

<p>One thing to be aware of, is that changes to the new module will trigger a
re-indexing of the relevant views. Make sure you only put code essential to
your views inside the <code>views/lib</code> directory.</p>
    </div>

    <script src="http://yandex.st/highlightjs/5.16/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-20477836-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
  </body>
</html>
